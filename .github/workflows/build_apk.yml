name: Build APK (Android container)
on:
  push: { branches: [ main ] }
  workflow_dispatch:

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    # Container con Android SDK 34 e build-tools preinstallati
    container: ghcr.io/cirruslabs/android-sdk:34

    steps:
      - uses: actions/checkout@v4

      # Java 17 dentro il container (openjdk-17-jdk è già presente; per sicurezza)
      - name: Ensure Java 17
        run: |
          java -version || true
          update-alternatives --list java || true

      - name: Unzip project
        run: |
          set -eux
          test -f NoGramTime_fixed.zip
          rm -rf project && mkdir project
          unzip -q NoGramTime_fixed.zip -d project
          # appiattisci se lo zip ha una sola cartella top-level
          TOP=$(find project -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [ "$TOP" = "1" ] && [ -z "$(find project -maxdepth 1 -type f -name 'build.gradle*' -o -name 'settings.gradle*')" ]; then
            DIR=$(find project -mindepth 1 -maxdepth 1 -type d | head -n1)
            shopt -s dotglob
            mv "$DIR"/* project/ || true
            rmdir "$DIR" || true
            shopt -u dotglob
          fi

      - name: Create minimal Gradle project if missing
        run: |
          set -eux
          cd project
          if ! find . -maxdepth 3 -name "build.gradle*" | grep -q . ; then
            mkdir -p app/src/main/java app/src/main/res
            cat > settings.gradle <<'EOF'
pluginManagement { repositories { gradlePluginPortal(); google(); mavenCentral() } }
dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories { google(); mavenCentral() }
}
rootProject.name = "NoGramTime"
include(":app")
EOF
            cat > build.gradle <<'EOF'
plugins { id 'com.android.application' version '8.6.1' apply false }
EOF
            cat > app/build.gradle <<'EOF'
plugins { id 'com.android.application' }
android {
  namespace 'com.example.nogramtime'
  compileSdk 34
  defaultConfig {
    applicationId 'com.example.nogramtime'
    minSdk 24
    targetSdk 34
    versionCode 1
    versionName "1.0"
  }
  buildTypes { release { minifyEnabled false } }
}
dependencies { }
EOF
          fi

      - name: Generate Gradle wrapper 8.7
        working-directory: project
        run: |
          gradle -v || true
          gradle wrapper --gradle-version 8.7

      - name: Build debug APK
        working-directory: project
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon --stacktrace --info assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NoGramTime-apk
          path: project/**/build/outputs/apk/debug/*.apk
          if-no-files-found: error
