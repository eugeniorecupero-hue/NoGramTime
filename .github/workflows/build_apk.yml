name: Build APK
on:
  push: { branches: [ main ] }
  workflow_dispatch:

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Android SDK + accept licenses
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-34
            build-tools;34.0.0
            platform-tools

      - name: Unzip project
        run: |
          set -eux
          test -f NoGramTime_fixed.zip
          rm -rf project && mkdir project
          unzip -q NoGramTime_fixed.zip -d project
          sudo apt-get update -y
          sudo apt-get install -y tree dos2unix
          echo "=== TREE (level 2) ==="
          tree -L 2 project || true
          # Se lo zip ha una sola cartella al top, appiattisci
          TOP=$(find project -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [ "$TOP" = "1" ] && [ -z "$(find project -maxdepth 1 -type f -name 'build.gradle*' -o -name 'settings.gradle*')" ]; then
            DIR=$(find project -mindepth 1 -maxdepth 1 -type d | head -n1)
            shopt -s dotglob
            mv "$DIR"/* project/ || true
            rmdir "$DIR" || true
            shopt -u dotglob
          fi
          echo "=== TREE (level 3) AFTER FLATTEN ==="
          tree -L 3 project || true

      - name: Create minimal Gradle project if missing
        run: |
          set -eux
          cd project
          if ! find . -maxdepth 3 -name "build.gradle*" | grep -q . ; then
            mkdir -p app/src/main/java app/src/main/res
            cat > settings.gradle <<'EOF'
pluginManagement { repositories { gradlePluginPortal(); google(); mavenCentral() } }
dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories { google(); mavenCentral() }
}
rootProject.name = "NoGramTime"
include(":app")
EOF
            cat > build.gradle <<'EOF'
plugins { id 'com.android.application' version '8.6.1' apply false }
EOF
            cat > app/build.gradle <<'EOF'
plugins { id 'com.android.application' }
android {
  namespace 'com.example.nogramtime'
  compileSdk 34
  defaultConfig {
    applicationId 'com.example.nogramtime'
    minSdk 24
    targetSdk 34
    versionCode 1
    versionName "1.0"
  }
  buildTypes { release { minifyEnabled false } }
}
dependencies { }
EOF
          fi

      - name: Generate Gradle wrapper 8.7
        uses: gradle/gradle-build-action@v2
        with:
          build-root-directory: project
          arguments: wrapper --gradle-version 8.7

      - name: Normalize line endings + perms
        run: |
          set -eux
          cd project
          dos2unix gradlew || true
          chmod +x gradlew
          find . -name "*.sh" -exec chmod +x {} \; || true

      - name: Build debug APK (verbose)
        run: |
          set -eux
          cd project
          ./gradlew --no-daemon --stacktrace --info assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: NoGramTime-apk
          path: project/**/build/outputs/apk/debug/*.apk
          if-no-files-found: error
